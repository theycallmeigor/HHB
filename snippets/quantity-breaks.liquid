{% liquid
  assign item_count = 0
  if block.settings.option_1_quantity != 0
    assign item_count = item_count | plus: 1
    assign last_offer_index = 1
  endif
  if block.settings.option_2_quantity != 0
    assign item_count = item_count | plus: 1
    assign last_offer_index = 2
  endif
  if block.settings.option_3_quantity != 0
    assign item_count = item_count | plus: 1
    assign last_offer_index = 3
  endif
  if block.settings.option_4_quantity != 0
    assign item_count = item_count | plus: 1
    assign last_offer_index = 4
  endif

  assign has_second_option = false
  if product.options.size >= 2
    assign has_second_option = true
  endif

  assign has_badge = false
  if block.settings.option_1_badge != blank or block.settings.option_2_badge != blank or block.settings.option_3_badge != blank or block.settings.option_4_badge != blank
    assign has_badge = true
  endif
  
  assign variants_available_arr = product.variants | map: 'available'
  assign variants_option1_arr = product.variants | map: 'option1'
  assign variants_option2_arr = product.variants | map: 'option2'
  assign variants_option3_arr = product.variants | map: 'option3'

  assign has_variants = false
  assign base_price = product.selected_or_first_available_variant.price
  
  # Check for subscription capability via cc_sub_id metafield
  assign has_subscription = false
  assign cc_sub_id = ''
  
  if product.metafields.custom.cc_sub_id != blank
    assign has_subscription = true
    assign cc_sub_id = product.metafields.custom.cc_sub_id
  elsif product.metafields.checkoutchamp.cc_sub_id != blank
    assign has_subscription = true
    assign cc_sub_id = product.metafields.checkoutchamp.cc_sub_id
  elsif product.metafields.cc.cc_sub_id != blank
    assign has_subscription = true
    assign cc_sub_id = product.metafields.cc.cc_sub_id
  endif
  
  # Also check variant metafields
  if product.selected_or_first_available_variant.metafields.custom.cc_sub_id != blank
    assign has_subscription = true
    assign cc_sub_id = product.selected_or_first_available_variant.metafields.custom.cc_sub_id
  elsif product.selected_or_first_available_variant.metafields.checkoutchamp.cc_sub_id != blank
    assign has_subscription = true
    assign cc_sub_id = product.selected_or_first_available_variant.metafields.checkoutchamp.cc_sub_id
  endif
  
  assign subscription_discount = block.settings.subscription_discount | default: 15
  assign show_subscription = has_subscription or block.settings.always_show_subscription
%}

{%- comment -%} Purchase Type Toggle (One-time vs Subscribe & Save) {%- endcomment -%}
{%- if show_subscription and block.settings.enable_subscription -%}
  <div class="quantity-breaks__purchase-type" data-cc-sub-id="{{ cc_sub_id }}">
    <div class="purchase-type__options">
      <label class="purchase-type__option purchase-type__option--onetime">
        <input 
          type="radio" 
          name="purchase_type_{{ section.id }}" 
          value="onetime"
          checked
          class="purchase-type__input visually-hidden"
          data-purchase-type="onetime"
          form="{{ product_form_id }}"
        >
        <span class="purchase-type__button">
          <span class="purchase-type__icon">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
              <circle cx="10" cy="10" r="4" fill="currentColor" class="purchase-type__check"/>
            </svg>
          </span>
          <span class="purchase-type__label">
            {{ block.settings.onetime_label | default: 'One-time purchase' }}
          </span>
        </span>
      </label>
      
      <label class="purchase-type__option purchase-type__option--subscribe">
        <input 
          type="radio" 
          name="purchase_type_{{ section.id }}" 
          value="subscribe"
          class="purchase-type__input visually-hidden"
          data-purchase-type="subscribe"
          form="{{ product_form_id }}"
        >
        <span class="purchase-type__button">
          <span class="purchase-type__icon">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
              <circle cx="10" cy="10" r="4" fill="currentColor" class="purchase-type__check"/>
            </svg>
          </span>
          <span class="purchase-type__label">
            {{ block.settings.subscribe_label | default: 'Subscribe & Save' }}
            <span class="purchase-type__badge color-{{ block.settings.subscription_badge_color | default: block.settings.color_scheme }}">
              {{ block.settings.subscription_badge_text | default: 'Save [discount]%' | replace: '[discount]', subscription_discount }}
            </span>
          </span>
        </span>
      </label>
    </div>
    
    <div class="purchase-type__details" data-subscription-details style="display: none;">
      <div class="subscription-frequency">
        <label for="subscription-frequency-{{ section.id }}" class="subscription-frequency__label">
          {{ block.settings.frequency_label | default: 'Deliver every' }}
        </label>
        <select 
          id="subscription-frequency-{{ section.id }}"
          name="properties[subscription_frequency]"
          class="subscription-frequency__select select__select"
          form="{{ product_form_id }}"
          data-subscription-frequency
        >
          <option value="15">15 days</option>
          <option value="30" selected>30 days</option>
          <option value="45">45 days</option>
          <option value="60">60 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
      
      {%- if block.settings.show_subscription_benefits -%}
        <ul class="subscription-benefits">
          <li class="subscription-benefits__item">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ block.settings.benefit_1 | default: 'Free shipping on all orders' }}
          </li>
          <li class="subscription-benefits__item">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ block.settings.benefit_2 | default: 'Cancel or pause anytime' }}
          </li>
          <li class="subscription-benefits__item">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ block.settings.benefit_3 | default: 'Exclusive subscriber offers' }}
          </li>
        </ul>
      {%- endif -%}
    </div>
    
    {%- comment -%} Hidden inputs for CheckoutChamp integration {%- endcomment -%}
    <input type="hidden" name="properties[_subscription_enabled]" value="false" data-subscription-enabled form="{{ product_form_id }}">
    <input type="hidden" name="properties[_cc_sub_id]" value="{{ cc_sub_id }}" data-cc-sub-id form="{{ product_form_id }}">
    <input type="hidden" name="properties[_subscription_discount]" value="{{ subscription_discount }}" data-subscription-discount form="{{ product_form_id }}">
  </div>
  
  <style>
    /* Purchase Type Styles - Integrated with quantity breaks design */
    .quantity-breaks__purchase-type {
      margin-bottom: calc(var(--margin-bottom) + 0.5rem);
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgba(var(--color-foreground), 0.08);
    }
    
    .purchase-type__options {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .purchase-type__option {
      flex: 1;
      position: relative;
    }
    
    .purchase-type__button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      border: var(--border-width) solid rgba(var(--color-foreground), 0.2);
      border-radius: var(--border-radius);
      background: rgba(var(--color-background), 1);
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }
    
    .purchase-type__input:checked + .purchase-type__button {
      border-color: var(--text-accent-color);
      background: rgba(var(--color-foreground), 0.03);
    }
    
    .purchase-type__input:checked + .purchase-type__button .purchase-type__check {
      opacity: 1;
    }
    
    .purchase-type__button:hover {
      border-color: var(--text-accent-color);
    }
    
    .purchase-type__icon svg {
      display: block;
      color: var(--text-accent-color);
    }
    
    .purchase-type__check {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .purchase-type__label {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
    }
    
    .purchase-type__badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 0.25rem;
      text-transform: uppercase;
    }
    
    /* Subscription Details */
    .purchase-type__details {
      padding: 1rem;
      background: rgba(var(--color-foreground), 0.03);
      border-radius: var(--border-radius);
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .subscription-frequency {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .subscription-frequency__label {
      font-weight: 500;
      white-space: nowrap;
    }
    
    .subscription-frequency__select {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid rgba(var(--color-foreground), 0.2);
      border-radius: calc(var(--border-radius) * 0.5);
      background: rgba(var(--color-background), 1);
      font-size: 1rem;
    }
    
    .subscription-benefits {
      list-style: none;
      padding: 0;
      margin: 1rem 0 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .subscription-benefits__item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }
    
    .subscription-benefits__item svg {
      flex-shrink: 0;
      color: var(--text-accent-color);
    }
    
    /* Responsive */
    @media screen and (max-width: 749px) {
      .purchase-type__options {
        flex-direction: column;
      }
    }
    
    /* Style variations */
    .quantity-breaks--compact .quantity-breaks__purchase-type {
      margin-bottom: 1rem;
    }
    
    .quantity-breaks--vertical .purchase-type__options {
      flex-direction: column;
    }
  </style>
{%- endif -%}

<quantity-breaks
  class="quantity-breaks quantity-breaks--{{ block.settings.style }} accent-color-{{ block.settings.color_scheme }}{% if block.settings.space_images %} quantity-breaks--space-images{% endif %}{% if has_badge %} quantity-breaks--has-badge{% endif %}{% if block.settings.full_width_pickers %} quantity-breaks-full-width-pickers{% endif %} quantity-breaks--vertical-image-{{ block.settings.vertical_images_position }}{% if block.settings.display_selected_indicator %} quantity-breaks--show-indicator{% endif %}{% if block.settings.indicator_top == false %} quantity-breaks--indicator-bottom{% endif %}{% if block.settings.image_width == 100 %} quantity-breaks--max-width-images{% endif %}{% if show_subscription and block.settings.enable_subscription %} quantity-breaks--has-subscription{% endif %}"
  id="quantity-breaks-{{ section.id }}"
  data-section="{{ section.id }}"
  data-items="{{ item_count }}"
  {% if has_second_option %}
    data-update-unavailable="true"
  {% endif %}
  data-update-prices="{{ block.settings.update_prices }}"
  data-update-pdp-prices="{{ block.settings.update_pdp_prices }}"
  data-money-format="{{ shop.money_format | escape }}"
  data-base-price="{{ product.selected_or_first_available_variant.price }}"
  data-skip-non-existent='true'
  data-skip-unavailable="{{ block.settings.skip_unavailable }}"
  {% if block.settings.scroll_media_gallery == false %}
    data-prevent-gallery-scroll="true"
  {% endif %}
  {% if show_subscription %}
    data-subscription-enabled="{{ block.settings.enable_subscription }}"
    data-subscription-discount="{{ subscription_discount }}"
    data-cc-sub-id="{{ cc_sub_id }}"
  {% endif %}
  style="--items-count:{{ item_count }};--image-width:{{ block.settings.image_width }}%;--border-radius:{{ block.settings.border_radius | divided_by: 10.0 }}rem;--border-width:{{ block.settings.border_width | divided_by: 10.0 }}rem;--text-accent-color:var(--color-base-{{ block.settings.accent_color }});--vertical-items-align:{{ block.settings.vertical_items_align }};{% if block.settings.hide_pickers_overlay %}--pickers-overlay-opacity:0;--pickers-hover-overlay-opacity:0;{% endif %}--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;"
  {{ block.shopify_attributes }}
>
  {% if block.settings.headline != blank %}
    <h3 class="quantity-breaks__title flex-center center">
      <span></span>
      <span>{{ block.settings.headline }}</span>
      <span></span>
    </h3>
  {% endif %}
  <div class="quantity-breaks-container">
    {% for i in (1..4) %}
      {% liquid
        assign preselected = false
        assign offer_index = forloop.index
        case i
          when 1
            assign qty = block.settings.option_1_quantity
            assign badge = block.settings.option_1_badge
            assign badge_style = block.settings.option_1_badge_style
            assign badge_color = block.settings.option_1_badge_color
            assign image = block.settings.option_1_image
            assign label = block.settings.option_1_label
            assign benefit = block.settings.option_1_benefit
            assign benefit_position = block.settings.option_1_benefit_position
            assign benefit_style = block.settings.option_1_benefit_style
            assign benefit_radius = block.settings.option_1_benefit_radius | divided_by: 100.0 | times: 1.33
            assign benefit_color = block.settings.option_1_benefit_color
            assign caption = block.settings.option_1_caption
            assign percentage_off = block.settings.option_1_percentage_off_text
            assign fixed_off = block.settings.option_1_fixed_amount_off
            assign price_text = block.settings.option_1_price_text
            assign compare_mode = block.settings.option_1_compare_price
            assign compare_text = block.settings.option_1_compare_price_text
            if block.settings.preselected == 'option_1'
              assign preselected = true
            endif
          when 2
            assign qty = block.settings.option_2_quantity
            assign badge = block.settings.option_2_badge
            assign badge_style = block.settings.option_2_badge_style
            assign badge_color = block.settings.option_2_badge_color
            assign image = block.settings.option_2_image
            assign label = block.settings.option_2_label
            assign benefit = block.settings.option_2_benefit
            assign benefit_position = block.settings.option_2_benefit_position
            assign benefit_style = block.settings.option_2_benefit_style
            assign benefit_radius = block.settings.option_3_benefit_radius | divided_by: 100.0 | times: 1.33
            assign benefit_color = block.settings.option_2_benefit_color
            assign caption = block.settings.option_2_caption
            assign percentage_off = block.settings.option_2_percentage_off_text
            assign fixed_off = block.settings.option_2_fixed_amount_off
            assign price_text = block.settings.option_2_price_text
            assign compare_mode = block.settings.option_2_compare_price
            assign compare_text = block.settings.option_2_compare_price_text
            if block.settings.preselected == 'option_2'
              assign preselected = true
            endif
          when 3
            assign qty = block.settings.option_3_quantity
            assign badge = block.settings.option_3_badge
            assign badge_style = block.settings.option_3_badge_style
            assign badge_color = block.settings.option_3_badge_color
            assign image = block.settings.option_3_image
            assign label = block.settings.option_3_label
            assign benefit = block.settings.option_3_benefit
            assign benefit_position = block.settings.option_3_benefit_position
            assign benefit_style = block.settings.option_3_benefit_style
            assign benefit_radius = block.settings.option_3_benefit_radius | divided_by: 100.0 | times: 1.33
            assign benefit_color = block.settings.option_3_benefit_color
            assign caption = block.settings.option_3_caption
            assign percentage_off = block.settings.option_3_percentage_off_text
            assign fixed_off = block.settings.option_3_fixed_amount_off
            assign price_text = block.settings.option_3_price_text
            assign compare_mode = block.settings.option_3_compare_price
            assign compare_text = block.settings.option_3_compare_price_text
            if block.settings.preselected == 'option_3'
              assign preselected = true
            endif
          when 4
            assign qty = block.settings.option_4_quantity
            assign badge = block.settings.option_4_badge
            assign badge_style = block.settings.option_4_badge_style
            assign badge_color = block.settings.option_4_badge_color
            assign image = block.settings.option_4_image
            assign label = block.settings.option_4_label
            assign benefit = block.settings.option_4_benefit
            assign benefit_position = block.settings.option_4_benefit_position
            assign benefit_style = block.settings.option_4_benefit_style
            assign benefit_radius = block.settings.option_4_benefit_radius | divided_by: 100.0 | times: 1.33
            assign benefit_color = block.settings.option_4_benefit_color
            assign caption = block.settings.option_4_caption
            assign percentage_off = block.settings.option_4_percentage_off_text
            assign fixed_off = block.settings.option_4_fixed_amount_off
            assign price_text = block.settings.option_4_price_text
            assign compare_mode = block.settings.option_4_compare_price
            assign compare_text = block.settings.option_4_compare_price_text
            if block.settings.preselected == 'option_4'
              assign preselected = true
            endif
        endcase

        if qty > 0
          assign percentage = percentage_off | plus: 0
          assign percentage_left = 100 | minus: percentage | divided_by: 100.0
          assign fixed_discount = fixed_off | times: 100
  
          assign price = base_price | times: qty | times: percentage_left | minus: fixed_discount
  
          assign compare_price = base_price
          if compare_mode == 'compare_price' and product.selected_or_first_available_variant.compare_at_price > base_price
            assign compare_price = product.selected_or_first_available_variant.compare_at_price
          endif
          assign compare_total = compare_price | times: qty
          assign amount_saved = compare_total | minus: price
          assign amount_saved_rounded = amount_saved | divided_by: 100.0 | round | times: 100
          assign price_each = price | divided_by: qty
          assign compare_each = compare_total | divided_by: qty
        endif
      %}
      {% if qty > 0 %}
        <input
          id="quantity{{ i }}-{{ section.id }}"
          aria-label="Quantity"
          type="radio"
          name="quantity"
          value="{{ qty }}"
          form="{{ product_form_id }}"
          {% if preselected %}
            checked
          {% endif %}
          data-input="input_{{ i }}"
          data-subscription-compatible="true"
        >
        <label
          for="quantity{{ i }}-{{ section.id }}"
          class="quantity-break{% if badge != blank %} quantity-break--badge{% else %} quantity-break--no-badge{% endif %} quantity-break--badge-style-{{ badge_style }} quantity-break--benefit-{{ benefit_position }}"
          data-quantity="{{ qty }}"
          data-input="input_{{ i }}"
          data-base-compare-price="{{ compare_price }}"
          data-percentage-left="{{ percentage_left }}"
          data-fixed-discount="{{ fixed_discount }}"
          data-compare-mode="{{ compare_mode }}"
          data-original-price="{{ price }}"
          data-original-compare="{{ compare_total }}"
        >
          <div class="quantity-break__wrapper">
            {% if badge != blank %}
              <p class="quantity-break__badge dynamic-price variant-price-update color-{{ badge_color }}" data-text="{{ badge }}">
                {% render 'text-with-price',
                  text: badge,
                  quantity: qty,
                  price: price,
                  compare_price: compare_total,
                  amount_saved: amount_saved,
                  amount_saved_rounded: amount_saved_rounded,
                  price_each: price_each,
                  compare_price_each: compare_each
                %}
              </p>
            {% endif %}
          
            <div class='quantity-break__image-and-content'>
              {% if image != blank %}
                <div class='quantity-break__image'>
                  <img 
                    src='{{ image | image_url }}'
                    alt="{{ image.alt }}"
                    width='auto'
                    height='auto'
                    loading='lazy'
                  >
                </div>
              {% endif %}
          
              <div class="quantity-break__content">
                <div class="quantity-break__left">
                  <span class="quantity-break__label">
                    {% if label != blank %}
                      <span class="quantity-break__label-text dynamic-price variant-price-update" data-text="{{ label }}">
                        {% render 'text-with-price',
                          text: label,
                          quantity: qty,
                          price: price,
                          compare_price: compare_total,
                          amount_saved: amount_saved,
                          amount_saved_rounded: amount_saved_rounded,
                          price_each: price_each,
                          compare_price_each: compare_each
                        %}
                      </span>
                    {% endif %}
                    {% if benefit != blank %}
                      <span class="quantity-break__benefit quantity-break__benefit--{{ benefit_style }} accent-color-{{ benefit_color }} dynamic-price variant-price-update" data-text="{{ benefit }}" style="--benefit-border-radius:{{ benefit_radius }}em;">
                        {% render 'text-with-price',
                          text: benefit,
                          quantity: qty,
                          price: price,
                          compare_price: compare_total,
                          amount_saved: amount_saved,
                          amount_saved_rounded: amount_saved_rounded,
                          price_each: price_each,
                          compare_price_each: compare_each
                        %}
                      </span>
                    {% endif %}
                  </span>
          
                  {% if caption != blank %}
                    <span class="quantity-break__caption dynamic-price variant-price-update" data-text="{{ caption }}">
                      {% render 'text-with-price',
                        text: caption,
                        quantity: qty,
                        price: price,
                        compare_price: compare_total,
                        amount_saved: amount_saved,
                        amount_saved_rounded: amount_saved_rounded,
                        price_each: price_each,
                        compare_price_each: compare_each
                      %}
                    </span>
                  {% endif %}
                </div>
          
                <div class="quantity-break__right quantity-break__right--{{ block.settings.prices_layout }} dynamic-price">
                  {% if price_text != blank %}
                    <span class="quantity-break__price variant-price-update" data-text="{{ price_text }}" data-subscription-price>
                      {% render 'text-with-price',
                        text: price_text,
                        quantity: qty,
                        price: price,
                        compare_price: compare_total,
                        amount_saved: amount_saved,
                        amount_saved_rounded: amount_saved_rounded,
                        price_each: price_each,
                        compare_price_each: compare_each
                      %}
                    </span>
                  {% endif %}
                  {% if compare_text != blank %}
                    <span class="quantity-break__compare-price variant-price-update{% if compare_total <= price %} hidden{% endif %}" data-text="{{ compare_text }}">
                      {% render 'text-with-price',
                        text: compare_text,
                        quantity: qty,
                        price: price,
                        compare_price: compare_total,
                        amount_saved: amount_saved,
                        amount_saved_rounded: amount_saved_rounded,
                        price_each: price_each,
                        compare_price_each: compare_each
                      %}
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>
            {% if product.has_only_default_variant == false and block.settings.enable_variant_selectors %}
              {% if qty != 1 or block.settings.enable_variant_selectors_on_quantity_of_1 %}
                <div class="quantity-break__variants">
                  {% assign has_variants = true %}
                  {% if block.settings.pickers_label != blank %}
                    <span class='quantity-break__variants__label'>
                      {{ block.settings.pickers_label }}
                    </span>
                  {% endif %}
                  {% for selectorItem in (1..qty) %}
                    <div
                      class="quantity-break__selector-item quantity-break__selector-item--variant-images-{{ block.settings.variant_images_position }}"
                      data-select-index="{{ forloop.index0 }}"
                      data-selected-id="{{ product.selected_or_first_available_variant.id }}"
                    >
                      <span class="quantity-break__selector-item__number">{{ block.settings.pickers_number_text | replace: '[index]', selectorItem }}</span>
                      {% for option in product.options_with_values %}
                        <div class="select select--small no-background color-{{ settings.pickers_color_scheme }} accent-color-{{ settings.pickers_overlay_color }} accent-2-color-{{ settings.pickers_text_color }}">
                          <select
                            class="quantity-break__variant-select select__select variant-dropdown"
                            name="options[{{ option.name | escape }}]"
                            data-product-id="{{ product.selected_or_first_available_variant.id }}"
                          >
                            {% for value in option.values %}
                              {% liquid
                                assign option_class = ''
                                assign option_disabled = true
                                assign option_exists = false
          
                                for option1_name in variants_option1_arr
                                  case option.position
                                    when 1
                                      if variants_option1_arr[forloop.index0] == value
                                        assign option_exists = true
                                        if variants_available_arr[forloop.index0]
                                          assign option_disabled = false
                                        endif
                                      endif
                                    when 2
                                      if option1_name == product.selected_or_first_available_variant.option1 and variants_option2_arr[forloop.index0] == value
                                        assign option_exists = true
                                        if variants_available_arr[forloop.index0]
                                          assign option_disabled = false
                                        endif
                                      endif
                                    when 3
                                      if option1_name == product.selected_or_first_available_variant.option1 and variants_option2_arr[forloop.index0] == product.selected_or_first_available_variant.option2 and variants_option3_arr[forloop.index0] == value
                                        assign option_exists = true
                                        if variants_available_arr[forloop.index0]
                                          assign option_disabled = false
                                        endif
                                      endif
                                  endcase
                                endfor

                                assign hidden = false
                                if option_exists == false
                                  assign option_class = 'non-existent'
                                  assign hidden = true
                                elsif option_disabled == true
                                  assign option_class = 'unavailable'
                                  if block.settings.skip_unavailable
                                    assign hidden = true
                                  endif
                                endif
                              %}
                              <option
                                value="{{ value | escape }}"
                                {% if option.selected_value == value %}
                                  selected="selected"
                                {% endif %}
                                class="{{ option_class }}"
                                {% if hidden %}
                                  disabled hidden
                                {% endif %}
                              >
                                {% if option_disabled %}
                                  {{ 'products.product.value_unavailable' | t: option_value: value }}
                                {% else %}
                                  {{ value }}
                                {% endif %}
                              </option>
                            {% endfor %}
                          </select>
                          {% render 'icon-caret' %}
                        </div>
                      {% endfor %}
                      {% if block.settings.show_selected_variant_images %}
                        <div class="quantity-break__selector-item__image media media--transparent">
                          <img
                            src="{{ product.selected_or_first_available_variant.featured_image | image_url: width: 600 }}"
                            alt="{{ product.selected_or_first_available_variant.featured_image.alt }}"
                            width="auto"
                            height="auto"
                            loading="lazy"
                          >
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endif %}
          </div>
          
          {% if block.settings.style == 'normal' %}
            <quantity-break-upsells
              class="quantity-break__upsells-container"
              data-offer="{{ offer_index }}"
              data-last-offer="{{ last_offer_index }}"
              data-main-product="{{ product.handle }}"
              data-save-local-storage="true"
              data-section="{{ section.id }}"
            >
              <style>
                #quantity-breaks-{{ section.id }} .quantity-break__upsell--style-primary {
                  background: {{ block.settings.upsells_primary_style_bg_color }};
                  color: {{ block.settings.upsells_primary_style_text_color }};
                }
                #quantity-breaks-{{ section.id }} .quantity-break__upsell--style-secondary {
                  background: {{ block.settings.upsells_secondary_style_bg_color }};
                  color: {{ block.settings.upsells_secondary_style_text_color }};
                }
              </style>
              {% for i in (1..3) %}
                {% liquid
                  case i
                    when 1
                      assign upsell_product = block.settings.upsell_1_product
                      assign upsell_min_offer = block.settings.upsell_1_min_offer | plus: 0
                      assign upsell_type = block.settings.upsell_1_type
                      assign upsell_design = block.settings.upsell_1_design
                      assign upsell_image = block.settings.upsell_1_image
                      assign upsell_text_left = block.settings.upsell_1_text_left
                      assign upsell_text_right = block.settings.upsell_1_text_right
                      assign upsell_badge_text = block.settings.upsell_1_badge_text
                      assign upsell_badge_color_scheme = block.settings.upsells_primary_style_badge_color_scheme
                      if upsell_design == 'secondary'
                        assign upsell_badge_color_scheme = block.settings.upsells_secondary_style_badge_color_scheme
                      endif
                      assign badge_position = block.settings.upsell_1_badge_position
                    when 2
                      assign upsell_product = block.settings.upsell_2_product
                      assign upsell_min_offer = block.settings.upsell_2_min_offer | plus: 0
                      assign upsell_type = block.settings.upsell_2_type
                      assign upsell_design = block.settings.upsell_2_design
                      assign upsell_image = block.settings.upsell_2_image
                      assign upsell_text_left = block.settings.upsell_2_text_left
                      assign upsell_text_right = block.settings.upsell_2_text_right
                      assign upsell_badge_text = block.settings.upsell_2_badge_text
                      assign upsell_badge_color_scheme = block.settings.upsells_primary_style_badge_color_scheme
                      if upsell_design == 'secondary'
                        assign upsell_badge_color_scheme = block.settings.upsells_secondary_style_badge_color_scheme
                      endif
                      assign badge_position = block.settings.upsell_2_badge_position
                    when 3
                      assign upsell_product = block.settings.upsell_3_product
                      assign upsell_min_offer = block.settings.upsell_3_min_offer | plus: 0
                      assign upsell_type = block.settings.upsell_3_type
                      assign upsell_design = block.settings.upsell_3_design
                      assign upsell_image = block.settings.upsell_3_image
                      assign upsell_text_left = block.settings.upsell_3_text_left
                      assign upsell_text_right = block.settings.upsell_3_text_right
                      assign upsell_badge_text = block.settings.upsell_3_badge_text
                      assign upsell_badge_color_scheme = block.settings.upsells_primary_style_badge_color_scheme
                      if upsell_design == 'secondary'
                        assign upsell_badge_color_scheme = block.settings.upsells_secondary_style_badge_color_scheme
                      endif
                      assign badge_position = block.settings.upsell_3_badge_position
                  endcase
  
                  case upsell_min_offer
                    when 1
                      assign upsell_min_quantity = block.settings.option_1_quantity
                    when 2
                      assign upsell_min_quantity = block.settings.option_2_quantity
                    when 3
                      assign upsell_min_quantity = block.settings.option_3_quantity
                    when 4
                      assign upsell_min_quantity = block.settings.option_4_quantity
                    else
                      assign upsell_min_quantity = 1
                  endcase
                %}
                {% if upsell_product != blank and qty >= upsell_min_offer and upsell_product.available %}
                  {% liquid
                    assign is_checkbox = false
                    if upsell_type contains 'checkbox'
                      assign is_checkbox = true
                    endif
                    assign selected = true
                    if upsell_type == 'checkbox'
                      assign selected = false
                    endif
                  %}
                  {% capture price %}{{ upsell_product.price | money }}{% endcapture %}
                  {% capture compare_price %}<span style="text-decoration:line-through;">{{ upsell_product.compare_at_price | money }}</span>{% endcapture %}
                  {% capture amount_saved %}{{ upsell_product.compare_at_price | minus: upsell_product.price | money }}{% endcapture %}
                  {% capture amount_saved_rounded %}{{ upsell_product.compare_at_price | minus: upsell_product.price | divided_by: 100.0 | round | times: 100 | money }}{% endcapture %}
                  {% capture rendered_text_left %}
                    {{ upsell_text_left
                      | replace: '[title]', upsell_product.title
                      | replace: '[price]', price
                      | replace: '[compare_price]', compare_price
                      | replace: '[amount_saved]', amount_saved
                      | replace: '[amount_saved_rounded]', amount_saved_rounded
                    }}
                  {% endcapture %}
                  {% capture rendered_text_right %}
                    {{ upsell_text_right
                      | replace: '[title]', upsell_product.title
                      | replace: '[price]', price
                      | replace: '[compare_price]', compare_price
                      | replace: '[amount_saved]', amount_saved
                      | replace: '[amount_saved_rounded]', amount_saved_rounded
                    }}
                  {% endcapture %}
                  {% capture rendered_badge_text %}
                    {{ upsell_badge_text
                      | replace: '[title]', upsell_product.title
                      | replace: '[price]', price
                      | replace: '[compare_price]', compare_price
                      | replace: '[amount_saved]', amount_saved
                      | replace: '[amount_saved_rounded]', amount_saved_rounded
                    }}
                  {% endcapture %}
              
                  <div
                    class="quantity-break__upsell quantity-break__upsell--{{ upsell_type }} quantity-break__upsell--style-{{ upsell_design }}{% if block.settings.hide_upsells_on_non_selected %} quantity-break__upsell--hide-inactive{% endif %} gift--product-{{ upsell_product.handle }}"
                    data-toggle="{{ is_checkbox }}"
                    data-min-offer="{{ upsell_min_offer }}"
                    data-min-quantity="{{ upsell_min_quantity }}"
                    data-selected="{{ selected }}"
                    data-product="{{ upsell_product.first_available_variant.id }}"
                    data-handle="{{ upsell_product.handle }}"
                    data-type="{% if is_checkbox %}upsell{% else %}gift{% endif %}"
                    style="
                      --badge-radius: {{ block.settings.upsells_badge_radius | divided_by: 100.0 | times: 1.33 }}em;
                    "
                  >
                    <style>
                      .cart-item--product-{{ upsell_product.handle }} .quantity{% unless is_checkbox %}, .cart-item--product-{{ upsell_product.handle }} cart-remove-button{% endunless %} {
                        display: none;
                      }
                    </style>
                    {% if is_checkbox %}
                      {% render 'checkbox-icons' %}
                    {% endif %}
                    {% if upsell_image %}
                      <div class="quantity-break__upsell-image media media--transparent flex-shrink-0">
                        <img src="{{ upsell_image | image_url }}" loading="lazy" width="auto" height="auto" alt="{{ upsell_product.title | escape }}">
                      </div>
                    {% endif %}
                    <div class="quantity-break__upsell-content">
                      {% if rendered_text_left != blank %}
                        <div class="quantity-break__upsell-text">
                          {{ rendered_text_left }}
                        </div>
                      {% endif %}
                      {% if rendered_badge_text != blank %}
                        <div class="quantity-break__upsell-badge quantity-break__upsell-badge--{{ badge_position }} color-{{ upsell_badge_color_scheme }}">
                          {{ rendered_badge_text }}
                        </div>
                      {% endif %}
                      {% if rendered_text_right != blank %}
                        <div class="quantity-break__upsell-text quantity-break__upsell-text-right">
                          {{ rendered_text_right }}
                        </div>
                      {% endif %}
                    </div>
                    <product-form class='hidden' data-is-cart-upsell='true'>
                      {% assign upsell_product_form_id = 'GiftUpsellForm-' | append: section.id | append: block.id | append: offer_index | append: forloop.index %}
                      {%- form 'product',
                        upsell_product,
                        id: upsell_product_form_id,
                        class: 'form',
                        novalidate: 'novalidate',
                        data-type: 'add-to-cart-form'
                      -%}
                        <input type="hidden" name="id" value="{{ upsell_product.first_available_variant.id }}">
                        <button type='submit'>+</button>
                      {%- endform -%}
                    </product-form>
                  </div>
                {% endif %}
              {% endfor %}
            </quantity-break-upsells>
          {% endif %}
        </label>
      {% endif %}
    {% endfor %}
  </div>

  <script data-has-variants="{{ has_variants }}" type="application/json">
    {{ product.variants | json }}
  </script>
</quantity-breaks>

<script>
  // Subscription integration for quantity breaks
  document.addEventListener('DOMContentLoaded', function() {
    const quantityBreaks = document.querySelector('#quantity-breaks-{{ section.id }}');
    const purchaseTypeInputs = document.querySelectorAll('[data-purchase-type]');
    const subscriptionDetails = document.querySelector('[data-subscription-details]');
    const subscriptionEnabled = document.querySelector('[data-subscription-enabled]');
    
    if (!quantityBreaks || !purchaseTypeInputs.length) return;
    
    const subscriptionDiscount = parseFloat(quantityBreaks.dataset.subscriptionDiscount) || 15;
    const ccSubId = quantityBreaks.dataset.ccSubId;
    
    // Handle purchase type toggle
    purchaseTypeInputs.forEach(input => {
      input.addEventListener('change', function() {
        const isSubscription = this.value === 'subscribe';
        
        if (subscriptionDetails) {
          subscriptionDetails.style.display = isSubscription ? 'block' : 'none';
        }
        
        if (subscriptionEnabled) {
          subscriptionEnabled.value = isSubscription ? 'true' : 'false';
        }
        
        // Update prices with subscription discount
        updatePricesForSubscription(isSubscription);
        
        // Notify CheckoutChamp
        if (window.CC || window.CheckoutChamp) {
          const cc = window.CC || window.CheckoutChamp;
          if (isSubscription && ccSubId && cc.setSubscription) {
            cc.setSubscription({
              enabled: true,
              id: ccSubId,
              frequency: document.querySelector('[data-subscription-frequency]')?.value || 30,
              discount: subscriptionDiscount
            });
          }
        }
      });
    });
    
    function updatePricesForSubscription(isSubscription) {
      const priceElements = quantityBreaks.querySelectorAll('[data-subscription-price]');
      
      priceElements.forEach(element => {
        const parent = element.closest('.quantity-break');
        if (!parent) return;
        
        const originalPrice = parseFloat(parent.dataset.originalPrice);
        if (!originalPrice) return;
        
        if (isSubscription) {
          const discountedPrice = originalPrice * (1 - subscriptionDiscount / 100);
          // Update the displayed price with subscription discount
          updatePriceDisplay(element, discountedPrice);
        } else {
          // Restore original price
          updatePriceDisplay(element, originalPrice);
        }
      });
    }
    
    function updatePriceDisplay(element, price) {
      const moneyFormat = quantityBreaks.dataset.moneyFormat || '${{amount}}';
      const formattedPrice = formatMoney(price, moneyFormat);
      
      // Update the price text while preserving the structure
      const text = element.dataset.text;
      if (text) {
        element.innerHTML = text.replace(/\[price\]/g, formattedPrice);
      }
    }
    
    function formatMoney(cents, format) {
      if (window.Shopify && window.Shopify.formatMoney) {
        return window.Shopify.formatMoney(cents, format);
      }
      const dollars = (cents / 100).toFixed(2);
      return format.replace('{{amount}}', dollars);
    }
  });
</script>