{%- comment -%} Gate by metaobject cc.mapping {%- endcomment -%}
{%- assign cc_map = product.metafields.cc.mapping.value -%}
{%- assign show_subscribe = cc_map and (cc_map.subscription == true or cc_map.subscription == 'true') and cc_map.subscription_id != blank -%}

{%- assign default_mode = block.settings.default_selection -%}
{%- assign is_subscription_default = default_mode == 'subscription' and show_subscribe -%}

<div id="cc-purchase-options-{{ block.id }}"
     class="product-form__input purchase-options"
     data-form-id="{{ product_form_id }}">
  {% if show_subscribe %}
    <fieldset class="purchase-options__fieldset">
      <legend class="visually-hidden">Purchase options</legend>

      <label class="purchase-options__option">
        <input type="radio" class="purchase-options__radio"
               name="cc_purchase_mode_{{ section.id }}"
               value="onetime"
               {% unless is_subscription_default %}checked{% endunless %}>
        <span class="purchase-options__label">
          <span class="purchase-options__label-main">{{ block.settings.onetime_label | default: 'One-time purchase' }}</span>
          {% if block.settings.onetime_subtitle != blank %}<span class="purchase-options__label-sub">{{ block.settings.onetime_subtitle }}</span>{% endif %}
        </span>
      </label>

      <label class="purchase-options__option">
        <input type="radio" class="purchase-options__radio"
               name="cc_purchase_mode_{{ section.id }}"
               value="subscription"
               {% if is_subscription_default %}checked{% endif %}>
        <span class="purchase-options__label">
          <span class="purchase-options__label-main">{{ block.settings.subscription_label | default: 'Subscribe & Save' }}</span>
          {% if block.settings.subscription_subtitle != blank %}<span class="purchase-options__label-sub">{{ block.settings.subscription_subtitle }}</span>{% endif %}
        </span>
      </label>
    </fieldset>
  {% endif %}
  <input type="hidden" name="properties[purchase_option]"
         value="{% if is_subscription_default %}subscription{% else %}one-time{% endif %}"
         {% unless root_in_form %}form="{{ product_form_id }}"{% endunless %}>
  <input type="hidden" name="properties[cc_override_id]"
         value="{% if is_subscription_default %}{{ cc_map.subscription_id }}{% else %}{{ cc_map.one_time_id | default: '' }}{% endif %}"
         {% unless root_in_form %}form="{{ product_form_id }}"{% endunless %}>
</div>

<script>
(() => {
  const root = document.getElementById('cc-purchase-options-{{ block.id }}');
  if (!root) return;
  const po = root.querySelector('input[name="properties[purchase_option]"]');
  const cc = root.querySelector('input[name="properties[cc_override_id]"]');
  const subId = {{ cc_map.subscription_id | default: '' | json }};
const otId  = {{ cc_map.one_time_id  | default: '' | json }};

  function sync() {
    const picked = root.querySelector('input.purchase-options__radio:checked');
    const mode = picked ? picked.value : 'onetime';
    po.value = mode === 'subscription' ? 'subscription' : 'one-time';
    cc.value = mode === 'subscription' ? (subId || '') : (otId || '');
  }
  root.addEventListener('change', e => {
    if (e.target.classList.contains('purchase-options__radio')) sync();
  });
  sync();
})();
</script>