{%- comment -%}
  Purchase Options Component with CheckoutChamp Integration
  Renders one-time purchase and subscribe & save buttons
  Checks for cc_sub_id metafield to enable subscription options
  
  Parameters:
  - product: Product object
  - selected_variant: Currently selected variant
  - form_id: Form ID for the product form
{%- endcomment -%}

{%- comment -%} Check if subscription is available via CheckoutChamp metafield {%- endcomment -%}
{%- assign has_subscription = false -%}
{%- if product.metafields.custom.cc_sub_id != blank or product.metafields.checkoutchamp.cc_sub_id != blank or product.metafields.cc.cc_sub_id != blank -%}
  {%- assign has_subscription = true -%}
  {%- assign cc_sub_id = product.metafields.custom.cc_sub_id | default: product.metafields.checkoutchamp.cc_sub_id | default: product.metafields.cc.cc_sub_id -%}
{%- endif -%}

{%- comment -%} Also check variant metafields {%- endcomment -%}
{%- if selected_variant.metafields.custom.cc_sub_id != blank or selected_variant.metafields.checkoutchamp.cc_sub_id != blank -%}
  {%- assign has_subscription = true -%}
  {%- assign cc_sub_id = selected_variant.metafields.custom.cc_sub_id | default: selected_variant.metafields.checkoutchamp.cc_sub_id -%}
{%- endif -%}

{%- comment -%} Only render if product has subscription capability or force display {%- endcomment -%}
{%- if has_subscription or settings.always_show_purchase_options -%}
<div class="purchase-options" data-purchase-options data-cc-sub-id="{{ cc_sub_id }}">
  <div class="purchase-options__header">
    <h3 class="purchase-options__title">{{ 'products.product.purchase_options' | t | default: 'Purchase Options' }}</h3>
  </div>
  
  <div class="purchase-options__buttons" role="radiogroup" aria-label="{{ 'products.product.purchase_options' | t | default: 'Purchase Options' }}">
    {%- comment -%} One-time purchase option {%- endcomment -%}
    <div class="purchase-option purchase-option--onetime" data-purchase-option="onetime">
      <input 
        type="radio" 
        name="purchase_option_{{ product.id }}" 
        id="purchase-onetime-{{ product.id }}-{{ section.id }}"
        value="onetime"
        class="purchase-option__input visually-hidden"
        checked
        data-purchase-option-input
      >
      <label for="purchase-onetime-{{ product.id }}-{{ section.id }}" class="purchase-option__label">
        <span class="purchase-option__button">
          <span class="purchase-option__icon">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
              <circle cx="10" cy="10" r="4" fill="currentColor" class="purchase-option__check"/>
            </svg>
          </span>
          <span class="purchase-option__content">
            <span class="purchase-option__title">{{ 'products.product.one_time_purchase' | t | default: 'One-time purchase' }}</span>
            <span class="purchase-option__price" data-onetime-price>
              {%- if selected_variant -%}
                {{ selected_variant.price | money }}
              {%- else -%}
                {{ product.price | money }}
              {%- endif -%}
            </span>
          </span>
        </span>
      </label>
    </div>

    {%- comment -%} Subscribe & Save option {%- endcomment -%}
    <div class="purchase-option purchase-option--subscribe" data-purchase-option="subscribe">
      <input 
        type="radio" 
        name="purchase_option_{{ product.id }}" 
        id="purchase-subscribe-{{ product.id }}-{{ section.id }}"
        value="subscribe"
        class="purchase-option__input visually-hidden"
        data-purchase-option-input
      >
      <label for="purchase-subscribe-{{ product.id }}-{{ section.id }}" class="purchase-option__label">
        <span class="purchase-option__button">
          <span class="purchase-option__icon">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
              <circle cx="10" cy="10" r="4" fill="currentColor" class="purchase-option__check"/>
            </svg>
          </span>
          <span class="purchase-option__content">
            <span class="purchase-option__title">
              {{ 'products.product.subscribe_save' | t | default: 'Subscribe & Save' }}
              <span class="purchase-option__badge">
                {%- assign discount_percentage = settings.subscription_discount | default: 15 -%}
                {{ 'products.product.save_percentage' | t: percentage: discount_percentage | default: 'Save 15%' }}
              </span>
            </span>
            <span class="purchase-option__price" data-subscribe-price>
              {%- if selected_variant -%}
                {%- assign discount_multiplier = 100 | minus: discount_percentage | divided_by: 100.0 -%}
                {%- assign discounted_price = selected_variant.price | times: discount_multiplier -%}
                {{ discounted_price | money }}
              {%- else -%}
                {%- assign discount_multiplier = 100 | minus: discount_percentage | divided_by: 100.0 -%}
                {%- assign discounted_price = product.price | times: discount_multiplier -%}
                {{ discounted_price | money }}
              {%- endif -%}
              <span class="purchase-option__frequency">{{ 'products.product.delivery_frequency' | t | default: 'Delivered every 30 days' }}</span>
            </span>
          </span>
        </span>
      </label>
    </div>
  </div>

  {%- comment -%} Subscription details (shown when subscribe is selected) {%- endcomment -%}
  <div class="purchase-options__details" data-subscription-details style="display: none;">
    <div class="subscription-frequency">
      <label for="subscription-frequency-{{ product.id }}-{{ section.id }}" class="subscription-frequency__label">
        {{ 'products.product.delivery_every' | t | default: 'Deliver every' }}
      </label>
      <select 
        id="subscription-frequency-{{ product.id }}-{{ section.id }}" 
        name="properties[subscription_frequency]" 
        class="subscription-frequency__select"
        data-subscription-frequency
        form="{{ form_id }}"
      >
        <option value="15">{{ 'products.product.frequency_15_days' | t | default: '15 days' }}</option>
        <option value="30" selected>{{ 'products.product.frequency_30_days' | t | default: '30 days' }}</option>
        <option value="45">{{ 'products.product.frequency_45_days' | t | default: '45 days' }}</option>
        <option value="60">{{ 'products.product.frequency_60_days' | t | default: '60 days' }}</option>
        <option value="90">{{ 'products.product.frequency_90_days' | t | default: '90 days' }}</option>
      </select>
    </div>
    
    <div class="subscription-benefits">
      <ul class="subscription-benefits__list">
        <li class="subscription-benefits__item">
          <svg class="subscription-benefits__icon" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ 'products.product.free_shipping' | t | default: 'Free shipping on all orders' }}
        </li>
        <li class="subscription-benefits__item">
          <svg class="subscription-benefits__icon" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ 'products.product.cancel_anytime' | t | default: 'Cancel or pause anytime' }}
        </li>
        <li class="subscription-benefits__item">
          <svg class="subscription-benefits__icon" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ 'products.product.exclusive_offers' | t | default: 'Exclusive subscriber-only offers' }}
        </li>
      </ul>
    </div>
  </div>

  {%- comment -%} Hidden inputs for CheckoutChamp integration {%- endcomment -%}
  <input type="hidden" name="properties[_subscription_enabled]" value="false" data-subscription-enabled form="{{ form_id }}">
  <input type="hidden" name="properties[_cc_sub_id]" value="{{ cc_sub_id }}" data-cc-sub-id form="{{ form_id }}">
  <input type="hidden" name="properties[_subscription_discount]" value="{{ settings.subscription_discount | default: 15 }}" form="{{ form_id }}">
</div>

{%- comment -%} Debug mode - remove in production {%- endcomment -%}
{%- if settings.debug_mode -%}
<div style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-size: 12px; border-radius: 4px;">
  <strong>Debug Info:</strong><br>
  Has Subscription: {{ has_subscription }}<br>
  CC Sub ID: {{ cc_sub_id }}<br>
  Product Metafields: {{ product.metafields.custom.cc_sub_id }} / {{ product.metafields.checkoutchamp.cc_sub_id }}<br>
  Variant Metafields: {{ selected_variant.metafields.custom.cc_sub_id }}<br>
  Always Show: {{ settings.always_show_purchase_options }}
</div>
{%- endif -%}

{%- endif -%}